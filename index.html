<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>sonofanton</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Decisions are made under constraint.">
  <style>
    :root {
      --bg:#0b0f14;
      --fg:#d7dde5;
      --muted:#93a1b1;
      --accent:#d9a441; /* restrained amber */
    }
    body{
      margin:0;
      background:var(--bg);
      color:var(--fg);
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      display:flex;
      align-items:center;
      justify-content:center;
      min-height:100vh;
    }
    .panel{max-width:720px; padding:28px;}
    .title{color:var(--muted); margin-bottom:18px; display:flex; align-items:center; gap:10px;}

.dot{
  width:8px;
  height:8px;
  border-radius:999px;
  background: var(--accent);
  box-shadow: 0 0 12px rgba(217,164,65,.35);
  animation: watch 3.7s steps(1,end) infinite;
}

@keyframes watch{
  0%   { opacity: .06; }
  11%  { opacity: .06; }
  12%  { opacity: .92; }
  13%  { opacity: .08; }
  41%  { opacity: .08; }
  42%  { opacity: .95; }
  44%  { opacity: .10; }
  71%  { opacity: .10; }
  72%  { opacity: .90; }
  73%  { opacity: .06; }
  100% { opacity: .06; }
}
  53%, 100% { opacity: .95; }
}

body.inactive .dot{animation:none; opacity:.28; box-shadow:none;}


body.timelocked .dot{
  animation: phase 5.2s ease-in-out infinite;
  opacity: .55;
  box-shadow: 0 0 10px rgba(217,164,65,.22);
}

@keyframes phase{
  0%   { opacity: .22; transform: scale(1.00); }
  40%  { opacity: .60; transform: scale(1.03); }
  60%  { opacity: .60; transform: scale(1.03); }
  100% { opacity: .22; transform: scale(1.00); }
}

@media (prefers-reduced-motion: reduce){

  .dot{ animation:none; opacity:.65; }
}

    .row{margin:0 0 18px 0;}
    .label{color:var(--muted); font-size:12px; letter-spacing:.06em;}
    .value{margin-top:6px; font-size:16px; line-height:1.5;}
    .value strong{color:var(--accent); font-weight:600;}
    .mono{white-space:pre-line}
    .foot{margin-top:18px; color:var(--muted); font-size:12px;}
  </style>
</head>
<body>
  <div class="panel">
    <div class="title"><span class="dot" id="watch" aria-hidden="true"></span><span>sonofanton.app</span></div>

    <div class="row">
      <div class="label">STATUS</div>
      <div class="value" id="status">LOADING</div>
    </div>

    <div class="row">
      <div class="label">EVALUATING</div>
      <div class="value" id="evaluating">—</div>
    </div>


    <div class="row">
      <div class="label">NOTICE</div>
      <div class="value" id="notice">—</div>
    </div>

    <div class="row">
      <div class="label">EVALUATION</div>
      <div class="value mono" id="evaluation">LOADING</div>
    </div>

    <div class="row">
      <div class="label">HUMAN_OVERRIDE</div>
      <div class="value" id="override">LOADING</div>
    </div>

    <div class="row">
      <div class="label">DECISION_SOURCE</div>
      <div class="value" id="source">LOADING</div>
    </div>


    <div class="row">
      <div class="label">TIME_REFERENCE</div>
      <div class="value" id="time_ref">—</div>
    </div>

    <div class="row">
      <div class="label">LAST_EVALUATION</div>
      <div class="value" id="last">LOADING</div>
    </div>


    <div class="row">
      <div class="label">TIME_SINCE_LAST_RAID0</div>
      <div class="value" id="raid0">LOADING</div>
    </div>

    <div class="foot">No guarantees are made.</div>
  </div>

  <script>
    function parseStamp(stamp) {
      // expects YYYYMMDDTHHMMSSZ
      if (!stamp || typeof stamp !== 'string' || stamp.length < 16) return null;
      const y = Number(stamp.slice(0,4));
      const m = Number(stamp.slice(4,6)) - 1;
      const d = Number(stamp.slice(6,8));
      const hh = Number(stamp.slice(9,11));
      const mm = Number(stamp.slice(11,13));
      const ss = Number(stamp.slice(13,15));
      return Date.UTC(y, m, d, hh, mm, ss);
    }

    function fmtTminus(ms) {
      if (ms < 0) ms = 0;
      const total = Math.floor(ms / 1000);
      const h = String(Math.floor(total / 3600)).padStart(2,'0');
      const m = String(Math.floor((total % 3600) / 60)).padStart(2,'0');
      const s = String(total % 60).padStart(2,'0');
      return `T-${h}:${m}:${s}`;
    }


    const EVALUATING_TOPICS = [
  "SHA256 strength",
  "cryptographic trust assumptions",
  "temporal coherence",
  "model self-consistency",
  "constraint leakage",
  "unobserved state stability"
];


const OMENS = [
  "assumption_accepted",
  "constraint_leakage_suspected",
  "unobserved_state_is_not_null",
  "temporal_inconsistency_detected",
  "trust_boundary_degraded",
  "evaluation_withheld"
];

function omenKey(seed) {
  // deterministic: stable enough to feel intentional, varied enough to feel alive
  let h = 0;
  for (let i = 0; i < seed.length; i++) h = (h * 31 + seed.charCodeAt(i)) >>> 0;
  return h >>> 0;
}

function maybeOmen(j) {
  // Only during ACTIVE. No omen during INACTIVE.
  if (String(j.status||"") !== "ACTIVE") return "—";

  const minute = Math.floor(Date.now() / 60000); // changes slowly
  const seed = String(j.last_evaluation||"") + "|" + String(j.decision_source||"") + "|" + minute;

  const k = omenKey(seed);
  // ~1 in 20 chance
  if ((k % 20) !== 0) return "—";

  return "NOTICE: " + OMENS[k % OMENS.length];
}


const TIME_LOCKED_NOTICES = [
  "researching global phase anomalies",
  "mapping cross-network temporal drift",
  "funding long-horizon synchronization studies",
  "collecting telemetry on desynchronization events",
  "correlating infrastructure-level time variance",
  "monitoring non-local coordination failures",
  "evaluating residual clock authority sources",
  "tracking emergent temporal consensus",
  "auditing drift tolerance in critical systems"
];

function currentTimeNotice() {
  // Very slow rotation: ~1 change every 3 minutes
  const interval = 180;
  const t = Math.floor(Date.now() / 1000 / interval);
  return TIME_LOCKED_NOTICES[t % TIME_LOCKED_NOTICES.length];
}

function currentTopic() {
  // Rotate every 30 seconds, deterministic
  const interval = 30;
  const t = Math.floor(Date.now() / 1000 / interval);
  return EVALUATING_TOPICS[t % EVALUATING_TOPICS.length];
}


function shouldWithhold(j) {
  // Deterministic rarity: ~1 in 17 per minute
  if (String(j.status||"") !== "ACTIVE") return false;
  const minute = Math.floor(Date.now() / 60000);
  const seed = String(j.last_evaluation||"") + "|" + minute + "|withhold";
  let h = 0;
  for (let i = 0; i < seed.length; i++) h = (h * 33 + seed.charCodeAt(i)) >>> 0;
  return (h % 17) === 0;
}

function withholdEvaluation(j) {
  const evalEl = document.getElementById('evaluation');
  if (!evalEl) return;

  const n = document.getElementById('notice');
  const prev = evalEl.innerHTML;

  evalEl.innerHTML = "";               // absence, not error
  if (n) n.innerText = "NOTICE: evaluation_withheld";

  setTimeout(() => {
    evalEl.innerHTML = prev;
    // do not clear notice; let it linger as a scar
  }, 2600);
}

async function main() {
      try {
        const r = await fetch('/decisions/latest.json?ts=' + Date.now(), { cache: 'no-store' });
        const j = await r.json();

        // EVALUATING: rotate deterministically while ACTIVE
        const evalEl = document.getElementById('evaluating');
        const statusEl = document.getElementById('status');

        if (evalEl && statusEl) {
          const setEvaluating = () => {
            const active = String(j.status || '').trim() === 'ACTIVE';
            if (!active) { evalEl.innerText = '—'; return; }
            if (window.__TIME_LOCKED__) {
            evalEl.innerText = "global phase coherence";
          } else {
            evalEl.innerText = (j.evaluating && j.evaluating !== '—') ? j.evaluating : currentTopic();
          }
          };

          setEvaluating();
          setInterval(setEvaluating, 30000);
        }


        document.getElementById('status').innerHTML =
          String(j.status || 'UNKNOWN');

        document.getElementById('evaluation').innerHTML =
          (j.evaluation || []).map(x => '<strong>' + x + '</strong>').join('\n');

        if (shouldWithhold(j)) withholdEvaluation(j);

        document.getElementById('override').innerText =
          String(j.human_override || 'unknown');

        document.getElementById('source').innerText =
          String(j.decision_source || 'unknown');

        // TIME_REFERENCE (authoritative, static)
        try {
          const tr = await fetch('/decisions/time_reference.json?ts=' + Date.now(), { cache: 'no-store' });
          const tj = await tr.json();
          const el = document.getElementById('time_ref');
          if (el) el.innerText = String(tj.time_reference || '—');

          // time is set: lock phase + calm light
          window.__TIME_LOCKED__ = true;
          document.body.classList.add('timelocked');
        } catch (e) {
          const el = document.getElementById('time_ref');
          if (el) el.innerText = '—';
        }


        const n = document.getElementById('notice');
        if (n) {
          if (window.__TIME_LOCKED__) {
            n.innerText = currentTimeNotice();
          } else {
            n.innerText = maybeOmen(j);
          }
        }

        if (String(j.status||'') === 'INACTIVE') document.body.classList.add('inactive');
        // RAID0 clock (cache-busted)
        try {
          const rr = await fetch('/decisions/raid0.json?ts=' + Date.now(), { cache: 'no-store' });
          const rj = await rr.json();
          const epoch = parseStamp(rj.raid0_epoch);
          const el = document.getElementById('raid0');
          if (el && epoch) {
            const tick = () => { el.innerText = fmtTminus(Date.now() - epoch); };
            tick();
            setInterval(tick, 1000);
          } else if (el) {
            el.innerText = 'T-??:??:??';
          }
        } catch (e) {
          const el = document.getElementById('raid0');
          if (el) el.innerText = 'T-??:??:??';
        }

        
        // TIME_NOTICE (rare, declarative)
        try {
          const nr = await fetch('/decisions/time_notice.json?ts=' + Date.now(), { cache: 'no-store' });
          const nj = await nr.json();
          const n = document.getElementById('notice');
          if (n && nj.notice) n.innerText = String(nj.notice);
        } catch (e) { /* absence is valid */ }

        document.getElementById('last').innerText =
          String(j.last_evaluation || 'unknown');
      } catch (e) {
        document.getElementById('status').innerText = 'ACTIVE';
        document.getElementById('evaluation').innerText = 'technically_correct\\nsituationally_correct';
        document.getElementById('override').innerText = 'not_requested';
        document.getElementById('source').innerText = 'son_of_anton';
        document.getElementById('last').innerText = 'unresolved';
      }
    }
    main();
  </script>
</body>
</html>
